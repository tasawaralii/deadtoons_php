RewriteEngine On

# If file or directory exists, skip rewriting
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Force trailing slash
RewriteCond %{REQUEST_URI} !/$
RewriteRule ^(.*[^/])$ /$1/ [R=301,L]

# Pagination
RewriteRule ^page/([0-9]+)/$ /index.php?page=$1 [L,QSA]

# Categories/taxonomies with and without pagination
RewriteRule ^category/([^/]+)/page/([0-9]+)/$ /index.php?category=$1&page=$2 [L,QSA]
RewriteRule ^genres/([^/]+)/page/([0-9]+)/$ /index.php?genres=$1&page=$2 [L,QSA]
RewriteRule ^author/([^/]+)/page/([0-9]+)/$ /index.php?author=$1&page=$2 [L,QSA]
RewriteRule ^tag/([^/]+)/page/([0-9]+)/$ /index.php?tag=$1&page=$2 [L,QSA]

RewriteRule ^category/([^/]+)/$ /index.php?category=$1 [L,QSA]
RewriteRule ^genres/([^/]+)/$ /index.php?genres=$1 [L,QSA]
RewriteRule ^author/([^/]+)/$ /index.php?author=$1 [L,QSA]
RewriteRule ^tag/([^/]+)/$ /index.php?tag=$1 [L,QSA]

# If matching file exists, serve it
RewriteCond %{DOCUMENT_ROOT}/$1.php -f
RewriteRule ^([a-z0-9-]+)/$ /$1.php [L]

# Fallback to single.php if no file exists
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([a-z0-9-]+)/$ /single.php?slug=$1 [L]

# Deny all non-GET requests
<LimitExcept GET POST>
  Deny from all
</LimitExcept>
